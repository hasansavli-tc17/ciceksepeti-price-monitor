name: Multi-Site Price Monitor

on:
  schedule:
    # Her gÃ¼n 04:30, 09:00, 12:00, 15:00 UTC (TÃ¼rkiye saati: 07:30, 12:00, 15:00, 18:00)
    - cron: '30 4 * * *'          # 07:30 TR
    - cron: '0 9,12,15 * * *'     # 12:00, 15:00, 18:00 TR
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma
    inputs:
      run_multi_site:
        description: 'Multi-site fiyat taramasÄ±nÄ± Ã§alÄ±ÅŸtÄ±r (kokina her zaman Ã§alÄ±ÅŸÄ±r)'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  monitor:
    # Multi-site fiyat taramasÄ± sadece manuel tetikleme ve aÃ§Ä±kÃ§a istenirse Ã§alÄ±ÅŸÄ±r
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_multi_site == 'true' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Node dependencies
        run: npm ci
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: ğŸŒ¸ Run Multi-Site Price Monitor
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: node multi-site-price-monitor.js
      
      - name: ğŸ“Š Sync to BigQuery (if credentials available)
        continue-on-error: true
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS: ./gcp-key.json
        run: |
          if [ ! -z "$GCP_SERVICE_ACCOUNT_KEY" ] && [ ! -z "$GCP_PROJECT_ID" ]; then
            echo "$GCP_SERVICE_ACCOUNT_KEY" > ./gcp-key.json
            python bigquery_sync.py || echo "âš ï¸  BigQuery sync failed, continuing..."
            rm -f ./gcp-key.json
            echo "âœ… BigQuery sync attempted"
          else
            echo "âš ï¸  BigQuery credentials not found, skipping sync"
          fi
      
      - name: ğŸ’¾ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add multi_site_price_history.json benchmark_report.json
          git diff --staged --quiet || git commit -m "ğŸ¤– Multi-site price update - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
      
      - name: ğŸ“ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-data-${{ github.run_number }}
          path: |
            multi_site_price_history.json
            benchmark_report.json
          retention-days: 30

  kokina-monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Node dependencies
        run: npm ci
      
      - name: ğŸ„ Run Kokina Price Monitor
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        run: node kokina-price-monitor.js
      
      - name: ğŸ’¾ Commit and push kokina price history
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add kokina_price_history.json kokina_benchmark_report.json
          git diff --staged --quiet || git commit -m "ğŸ„ Kokina price update - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
      
      - name: ğŸ“ Upload kokina artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kokina-monitoring-data-${{ github.run_number }}
          path: |
            kokina_price_history.json
            kokina_benchmark_report.json
          retention-days: 30

