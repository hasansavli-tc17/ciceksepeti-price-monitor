name: Multi-Site Price Monitor

on:
  schedule:
    # Her gÃ¼n 06:00, 09:00, 13:00 UTC (TÃ¼rkiye saati: 09:00, 12:00, 16:00)
    - cron: '0 6,9,13 * * *'
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Node dependencies
        run: npm ci
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: ğŸŒ¸ Run Multi-Site Price Monitor
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: node multi-site-price-monitor.js
      
      - name: ğŸ“Š Sync to BigQuery (if credentials available)
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS: ./gcp-key.json
        run: |
          if [ ! -z "$GCP_SERVICE_ACCOUNT_KEY" ]; then
            echo "$GCP_SERVICE_ACCOUNT_KEY" > ./gcp-key.json
            python bigquery_sync.py
            rm -f ./gcp-key.json
            echo "âœ… BigQuery sync completed"
          else
            echo "âš ï¸  BigQuery credentials not found, skipping sync"
          fi
      
      - name: ğŸ’¾ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add multi_site_price_history.json benchmark_report.json
          git diff --staged --quiet || git commit -m "ğŸ¤– Multi-site price update - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
      
      - name: ğŸ“ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-data-${{ github.run_number }}
          path: |
            multi_site_price_history.json
            benchmark_report.json
          retention-days: 30

